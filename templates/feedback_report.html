<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback Reports - CCS Sit-In System</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
<style>
:root {
  --primary-color: #B4121B;        /* Bold Red */
  --secondary-color: #8A0E15;      /* Darker Red */
  --accent-color: #D11D27;         /* Slightly brighter red */
  --light-color: #f8fafc;          /* Off-white */
  --dark-color: #000000;           /* Pure Black */
  --success-color: #2a9d8f;        /* Teal */
  --warning-color: #e9c46a;        /* Gold */
  --danger-color: #B4121B;         /* Same as primary */
  --neutral-100: #f3f4f6;          /* Lighter gray */
  --neutral-200: #e5e7eb;          /* Light gray */
  --neutral-300: #d1d5db;          /* Gray */
  --neutral-400: #9ca3af;          /* Medium gray */
  --neutral-500: #6b7280;          /* Dark gray */
  --border-radius-sm: 4px;
  --border-radius: 8px;
  --border-radius-lg: 12px;
  --box-shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  --box-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  --transition: all 0.2s ease;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background-color: var(--light-color);
  color: var(--dark-color);
  min-height: 100vh;
  line-height: 1.5;
}

.header-banner {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  padding: 20px 0;
  position: relative;
}

.navbar {
  background-color: var(--light-color) !important;
  box-shadow: var(--box-shadow);
  padding: 0.75rem 1rem;
  border-bottom: 2px solid var(--primary-color);
}

.navbar .nav-link {
  color: var(--dark-color) !important;
  font-weight: 500;
  padding: 0.75rem 1rem !important;
  border-radius: var(--border-radius-sm);
  transition: var(--transition);
}

.navbar .nav-link:hover {
  color: var(--primary-color) !important;
  background-color: rgba(180, 18, 27, 0.08);
}

.navbar .nav-item.active .nav-link {
  background-color: var(--primary-color);
  color: white !important;
}

.card {
  border: none;
  border-radius: var(--border-radius-lg);
  box-shadow: var(--box-shadow);
  transition: var(--transition);
  margin-bottom: 1.5rem;
  overflow: hidden;
  background-color: white;
  border-top: 3px solid var(--primary-color);
}

.card:hover {
  box-shadow: var(--box-shadow-lg);
  transform: translateY(-2px);
}

.card-header {
  background: var(--dark-color);
  color: white;
  font-weight: 600;
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--primary-color);
}

.card-body {
  padding: 1.5rem;
}

.btn {
  border-radius: var(--border-radius);
  padding: 0.625rem 1.25rem;
  font-weight: 500;
  letter-spacing: 0.01em;
  transition: var(--transition);
  border: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background: var(--secondary-color);
  box-shadow: 0 4px 12px rgba(180, 18, 27, 0.25);
  color: white;
}

.btn-success {
  background: var(--success-color);
  color: white;
}

.btn-success:hover {
  background: #24877a;
  box-shadow: 0 4px 12px rgba(42, 157, 143, 0.25);
  color: white;
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  background: var(--secondary-color);
  box-shadow: 0 4px 12px rgba(180, 18, 27, 0.25);
  color: white;
}

.btn-info {
  background: var(--accent-color);
  color: white;
}

.btn-info:hover {
  background: #d92638;
  box-shadow: 0 4px 12px rgba(230, 57, 70, 0.25);
  color: white;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

.table {
  background-color: white;
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--box-shadow-sm);
  margin-bottom: 1.5rem;
  border: 1px solid var(--neutral-200);
}

.table thead th {
  background-color: var(--dark-color);
  color: white;
  border: none;
  font-weight: 600;
  padding: 0.875rem 1rem;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  border-bottom: 2px solid var(--primary-color);
}

.table td {
  padding: 1rem;
  vertical-align: middle;
  border-color: var(--neutral-200);
  color: var(--neutral-500);
}

.table tbody tr {
  transition: var(--transition);
}

.table tbody tr:hover {
  background-color: rgba(180, 18, 27, 0.03);
}

.message-cell {
  max-width: 400px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.message-cell p {
  margin-bottom: 0.5rem;
}

.badge {
  padding: 0.35em 0.65em;
  font-weight: 500;
  border-radius: var(--border-radius-sm);
  font-size: 0.75rem;
}

.badge-success {
  background-color: var(--success-color);
  color: white;
}

.badge-warning {
  background-color: var(--warning-color);
  color: white;
}

.badge-danger {
  background-color: var(--danger-color);
  color: white;
}

.modal-content {
  border-radius: var(--border-radius-lg);
  border: none;
  overflow: hidden;
  box-shadow: var(--box-shadow-lg);
  border-top: 3px solid var(--primary-color);
}

.modal-header {
  background: var(--dark-color);
  color: white;
  border-bottom: 1px solid var(--primary-color);
  padding: 1.25rem 1.5rem;
}

.modal-header .close {
  color: white;
  opacity: 0.8;
  transition: var(--transition);
}

.modal-header .close:hover {
  opacity: 1;
  color: white;
}

.modal-footer {
  border-top: 1px solid var(--neutral-200);
  padding: 1.25rem 1.5rem;
}

.form-control {
  border-radius: var(--border-radius);
  border: 1px solid var(--neutral-300);
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  transition: var(--transition);
  background-color: var(--light-color);
  margin-bottom: 1rem;
}

.form-control:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(180, 18, 27, 0.15);
  background-color: white;
}

.filter-bar {
  background-color: white;
  border-radius: var(--border-radius);
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--box-shadow);
  border-top: 3px solid var(--primary-color);
}

.page-item.active .page-link {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
}

.page-link {
  color: var(--primary-color);
  margin: 0 2px;
  border-radius: var(--border-radius-sm);
}

.page-link:hover {
  color: var(--secondary-color);
  background-color: rgba(180, 18, 27, 0.08);
}

@media print {
  .no-print {
    display: none;
  }
  .navbar, .header-banner {
    display: none;
  }
  .card {
    box-shadow: none;
    border: 1px solid var(--neutral-200);
  }
  .table {
    width: 100%;
    box-shadow: none;
    border: 1px solid var(--neutral-200);
  }
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 20px;
    width: 100%;
  }
  .print-header h1 {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    padding: 0;
    text-align: center;
    width: 100%;
  }
  .print-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    padding: 0;
    text-align: center;
    width: 100%;
  }
  .print-header h3 {
    font-size: 14px;
    margin: 0;
    padding: 0;
    margin-bottom: 15px;
    text-align: center;
    width: 100%;
  }
  .print-header .date {
    font-size: 12px;
    margin: 0;
    padding: 0;
    font-style: italic;
    text-align: center;
    width: 100%;
  }
  
  /* Center text in table headings */
  .table thead th {
    text-align: center;
  }
}

.print-header {
  display: none;
}
</style>
</head>

<body>
  <!-- Print Header (visible only when printing) -->
  <div class="print-header">
    <h1>University of Cebu Main Campus</h1>
    <h2>College of Computer Studies</h2>
    <h3>Sitin Monitoring System</h3>
  </div>

  <!-- Header Banner -->
  <div class="header-banner">
    <div class="container text-center">
      <h3 class="font-weight-bold mb-0">College of Computer Studies Admin</h3>
    </div>
  </div>

  <!-- Include Admin Navbar -->
  {% include 'admin_navbar.html' %}

  <!-- Add this after the navbar -->
  <div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="container py-5">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <i class="fas fa-comment-dots mr-2"></i> Student Feedback
            </div>
            <div>
              <button id="csvBtn" class="btn btn-sm btn-success mr-1"><i class="fas fa-file-csv mr-1"></i> CSV</button>
              <button id="excelBtn" class="btn btn-sm btn-primary mr-1"><i class="fas fa-file-excel mr-1"></i> Excel</button>
              <button id="pdfBtn" class="btn btn-sm btn-danger mr-1"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
              <button id="printBtn" class="btn btn-sm btn-info"><i class="fas fa-print mr-1"></i> Print</button>
            </div>
          </div>
          <div class="card-body">
            <div class="filter-bar d-flex justify-content-between align-items-center mb-4">
              <div class="d-flex align-items-center">
                <div class="mr-3">
                  <label for="datePicker" class="mb-0 mr-2">Date:</label>
                  <input type="date" id="datePicker" class="form-control form-control-sm">
                </div>
                <button id="searchBtn" class="btn btn-sm btn-primary mr-2">
                  <i class="fas fa-filter mr-1"></i> Filter
                </button>
                <button id="resetBtn" class="btn btn-sm btn-secondary">
                  <i class="fas fa-redo mr-1"></i> Reset
                </button>
              </div>
              <div class="position-relative">
                <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search...">
                <i class="fas fa-search position-absolute" style="right: 10px; top: 10px; color: #777;"></i>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover" id="feedbackTable">
                <thead>
                  <tr>
                    <th><i class="fas fa-id-card mr-1"></i> ID Number</th>
                    <th><i class="fas fa-user mr-1"></i> Name</th>
                    <th><i class="fas fa-graduation-cap mr-1"></i> Course</th>
                    <th><i class="fas fa-layer-group mr-1"></i> Year Level</th>
                    <th><i class="fas fa-comment mr-1"></i> Feedback Message</th>
                    <th><i class="fas fa-calendar-alt mr-1"></i> Date/Time</th>
                    <th><i class="fas fa-cogs mr-1"></i> Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% if feedback_entries %}
                    {% for feedback in feedback_entries %}
                      <tr>
                        <td>{{ feedback.student_id }}</td>
                        <td>{{ feedback.lastname }}, {{ feedback.firstname }}</td>
                        <td>{{ feedback.course }}</td>
                        <td>{{ feedback.year_level }}</td>
                        <td class="message-cell">{{ feedback.message }}
                          {% if feedback.feedback_response %}
                            <div class="mt-2 p-2 border-top">
                              <small class="text-muted">Admin Response:</small>
                              <p>{{ feedback.feedback_response }}</p>
                            </div>
                          {% endif %}
                        </td>
                        <td>{{ feedback.timestamp }}</td>
                        <td>
                          <button class="btn btn-sm btn-primary reply-feedback" data-toggle="modal" data-target="#replyModal" data-id="{{ feedback.id }}">
                            <i class="fas fa-reply mr-1"></i> Reply
                          </button>
                          <button class="btn btn-sm btn-danger delete-feedback" data-id="{{ feedback.id }}">
                            <i class="fas fa-trash mr-1"></i> Delete
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="7" class="text-center py-4">
                        <i class="fas fa-inbox fa-2x mb-3 text-muted"></i>
                        <p class="mb-0 text-muted">No feedback entries available</p>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            
            {% if feedback_entries and feedback_entries|length > 10 %}
            <div class="d-flex justify-content-between align-items-center mt-4">
              <div>
                <p class="text-muted mb-0">Showing 1 to {{ feedback_entries|length if feedback_entries|length < 10 else 10 }} of {{ feedback_entries|length }} entries</p>
              </div>
              <nav>
                <ul class="pagination pagination-sm mb-0" id="pagination">
                  <!-- Pagination will be generated by JavaScript -->
                </ul>
              </nav>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reply Feedback Modal -->
  <div class="modal fade" id="replyModal" tabindex="-1" role="dialog" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="replyModalLabel">Reply to Feedback</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="replyForm">
            <input type="hidden" id="feedback-id" value="">
            <div class="form-group">
              <label for="replyMessage"><i class="fas fa-comment-dots mr-1"></i> Your Response</label>
              <textarea class="form-control" id="replyMessage" rows="5" placeholder="Enter your response to the feedback..." required></textarea>
            </div>
            <div class="text-right">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">
                <i class="fas fa-times mr-1"></i> Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane mr-1"></i> Send
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>

  <script>
    $(document).ready(function() {
      // Table search functionality
      $("#tableSearch").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#feedbackTable tbody tr").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
        updatePagination();
      });
      
      // Date filter
      $("#searchBtn").click(function() {
        var date = $("#datePicker").val();
        if (date) {
          $("#feedbackTable tbody tr").hide();
          $("#feedbackTable tbody tr").filter(function() {
            return $(this).find("td:nth-child(6)").text().trim().includes(date);
          }).show();
        }
        updatePagination();
      });
      
      // Reset filter
      $("#resetBtn").click(function() {
        $("#datePicker").val("");
        $("#tableSearch").val("");
        $("#feedbackTable tbody tr").show();
        updatePagination();
      });
      
      // Initialize pagination
      updatePagination();
      
      // Reply to feedback
      $(".reply-feedback").click(function() {
        var feedbackId = $(this).data("id");
        $("#feedback-id").val(feedbackId);
      });
      
      // Submit feedback reply
      $("#replyForm").submit(function(e) {
        e.preventDefault();
        
        var feedbackId = $("#feedback-id").val();
        var replyMessage = $("#replyMessage").val().trim();
        
        if (!replyMessage) {
          alert("Please enter a reply message");
          return;
        }
        
        $.ajax({
          url: "/reply_to_feedback",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            sitin_id: feedbackId,
            response: replyMessage
          }),
          success: function(response) {
            alert("Reply sent successfully!");
            $("#replyModal").modal("hide");
            location.reload();
          },
          error: function(xhr, status, error) {
            var errorMessage = "An error occurred while sending your reply.";
            if (xhr.responseJSON && xhr.responseJSON.error) {
              errorMessage = xhr.responseJSON.error;
            }
            alert("Error: " + errorMessage);
          }
        });
      });
      
      // Delete feedback
      $(".delete-feedback").click(function() {
        var feedbackId = $(this).data("id");
        
        if (confirm("Are you sure you want to delete this feedback entry?")) {
          $.ajax({
            url: "/delete_feedback/" + feedbackId,
            type: "POST",
            success: function(response) {
              alert("Feedback deleted successfully!");
              location.reload();
            },
            error: function(xhr) {
              var errorMsg = "Error deleting feedback.";
              if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
              }
              alert(errorMsg);
            }
          });
        }
      });
      
      // Search student button click handler
      $('#searchStudentBtn').click(function() {
        const studentId = $('#searchInput').val().trim();
        if (studentId === '') {
          alert('Please enter a student ID');
          return;
        }
        
        window.location.href = `/view_student?id=${studentId}`;
      });
      
      // Export to CSV
      $("#csvBtn").click(function() {
        exportTableToCSV('feedback_reports.csv');
      });
      
      // Export to Excel
      $("#excelBtn").click(function() {
        exportTableToExcel('feedbackTable', 'feedback_reports');
      });
      
      // Export to PDF
      $("#pdfBtn").click(function() {
        exportTableToPDF();
      });
      
      // Print functionality
      $("#printBtn").click(function() {
        addDateToPrintHeader();
        window.print();
      });

      // Add date to print header
      function addDateToPrintHeader() {
        const today = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = today.toLocaleDateString('en-US', options);
        
        // Add date to print header if it doesn't exist yet
        if ($('.print-header .date').length === 0) {
          $('.print-header').append('<p class="date">Date: ' + dateString + '</p>');
        }
      }

      // Also call it when browser print is triggered
      window.onbeforeprint = addDateToPrintHeader;
    });
    
    function updatePagination() {
      const rowsPerPage = 10;
      const visibleRows = $("#feedbackTable tbody tr:visible").length;
      const totalPages = Math.ceil(visibleRows / rowsPerPage);
      
      let paginationHtml = '';
      
      if (visibleRows > rowsPerPage) {
        paginationHtml += `
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1">
              <i class="fas fa-chevron-left"></i>
            </a>
          </li>`;
          
        for (let i = 1; i <= totalPages; i++) {
          paginationHtml += `
            <li class="page-item ${i === 1 ? 'active' : ''}">
              <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>`;
        }
        
        paginationHtml += `
          <li class="page-item">
            <a class="page-link" href="#">
              <i class="fas fa-chevron-right"></i>
            </a>
          </li>`;
          
        $("#pagination").html(paginationHtml);
        
        // Set up page click handlers
        $(".page-link").click(function(e) {
          e.preventDefault();
          const page = $(this).data('page');
          if (page) {
            showPage(page, rowsPerPage);
            $(".page-item").removeClass("active");
            $(this).parent().addClass("active");
          }
        });
        
        // Show first page initially
        showPage(1, rowsPerPage);
      } else {
        $("#pagination").empty();
        $("#feedbackTable tbody tr:visible").show();
      }
    }
    
    function showPage(page, rowsPerPage) {
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      
      $("#feedbackTable tbody tr:visible").hide();
      $("#feedbackTable tbody tr:visible").slice(start, end).show();
    }
    
    // Function to export table to CSV
    function exportTableToCSV(filename) {
      try {
        var table = document.getElementById("feedbackTable");
        if (!table) {
          console.error("Table not found");
          alert("Could not find table to export");
          return;
        }
        
        // Use XLSX to create CSV
        var ws = XLSX.utils.table_to_sheet(table);
        var csv_string = XLSX.utils.sheet_to_csv(ws);
        
        // Create a Blob and trigger download
        var blob = new Blob([csv_string], { type: 'text/csv;charset=utf-8;' });
        
        if (navigator.msSaveBlob) { // IE 10+
          navigator.msSaveBlob(blob, filename);
        } else {
          var link = document.createElement("a");
          if (link.download !== undefined) {
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }
        }
      } catch (e) {
        console.error("CSV export error:", e);
        alert("Failed to export CSV file: " + e.message);
      }
    }
    
    // Function to export table to Excel
    function exportTableToExcel(tableID, filename = '') {
      try {
        var table = document.getElementById(tableID);
        if (!table) {
          console.error("Table not found");
          alert("Could not find table to export");
          return;
        }
        
        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.table_to_sheet(table, {raw: true});
        
        // Exclude the actions column
        var range = XLSX.utils.decode_range(ws['!ref']);
        for (var r = range.s.r; r <= range.e.r; ++r) {
          delete ws[XLSX.utils.encode_cell({r: r, c: 6})]; // Delete Actions column
        }
        
        XLSX.utils.book_append_sheet(wb, ws, "Feedback Reports");
        XLSX.writeFile(wb, filename + '.xlsx');
      } catch (e) {
        console.error("Excel export error:", e);
        alert("Failed to export Excel file: " + e.message);
      }
    }
    
    // Function to export table to PDF
    function exportTableToPDF() {
      try {
        const doc = new jsPDF('l', 'mm', 'a4');
        
        // Calculate column widths and total width
        const columnWidths = [20, 30, 25, 15, 80, 30]; // Width for each column
        const totalWidth = columnWidths.reduce((sum, width) => sum + width, 0);
        const tableStartX = (doc.internal.pageSize.width - totalWidth) / 2;
        
        // Add header as first rows of table instead of separate text
        const headerRows = [
            ['', '', 'University of Cebu Main Campus', '', '', ''],
            ['', '', 'College of Computer Studies', '', '', ''],
            ['', '', 'Sitin Monitoring System', '', '', ''],
            ['', '', '', '', '', ''] // Empty row as spacer
        ];
        
        // Get current date
        const today = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = today.toLocaleDateString('en-US', options);
        headerRows.push(['', '', 'Date: ' + dateString, '', '', '']);
        headerRows.push(['', '', '', '', '', '']); // Empty row as spacer
        
        // Get actual table data
        const tableData = [];
        $('#feedbackTable thead tr').each(function() {
            const row = [];
            $(this).find('th').each(function() {
                // Skip the Actions column
                if (!$(this).text().includes('Actions')) {
                    row.push($(this).text().replace(/^\s*[\r\n]/gm, '').trim());
                }
            });
            tableData.push(row);
        });
        
        $('#feedbackTable tbody tr:visible').each(function() {
            const row = [];
          $(this).find('td').each(function(index) {
                // Skip the Actions column (index 6)
                if (index < 6) {
                    row.push($(this).text().replace(/^\s*[\r\n]/gm, '').trim());
            }
          });
            tableData.push(row);
        });
        
        // Combine header rows with table data
        const fullTableData = [...headerRows, ...tableData];
        
        // Create table with autoTable plugin
        doc.autoTable({
            startY: 20,
            head: [],
            body: fullTableData,
          theme: 'grid',
          styles: {
            fontSize: 8,
            cellPadding: 2,
                overflow: 'linebreak',
                halign: 'center'
          },
          columnStyles: {
                0: {cellWidth: columnWidths[0]}, // ID
                1: {cellWidth: columnWidths[1]}, // Name
                2: {cellWidth: columnWidths[2]}, // Course
                3: {cellWidth: columnWidths[3]}, // Year Level
                4: {cellWidth: columnWidths[4]}, // Message
                5: {cellWidth: columnWidths[5]}  // Date/Time
          },
            didParseCell: function(data) {
                // Apply special styles to header rows
                if (data.row.index < 6) {
                    data.cell.styles.fillColor = [255, 255, 255]; // White background
                    data.cell.styles.textColor = [0, 0, 0]; // Black text
                    
                    // Make university name larger
                    if (data.row.index === 0 && data.column.index === 2) {
                        data.cell.styles.fontSize = 12;
                        data.cell.styles.fontStyle = 'bold';
                    }
                    // Make college name medium
                    else if (data.row.index === 1 && data.column.index === 2) {
                        data.cell.styles.fontSize = 10;
                        data.cell.styles.fontStyle = 'bold';
                    }
                    // Make system name smaller
                    else if (data.row.index === 2 && data.column.index === 2) {
                        data.cell.styles.fontSize = 9;
                    }
                    // Style date row
                    else if (data.row.index === 4 && data.column.index === 2) {
                        data.cell.styles.fontSize = 8;
                        data.cell.styles.fontStyle = 'italic';
                    }
                }
                // Apply table header styles (row index 6)
                else if (data.row.index === 6) {
                    data.cell.styles.fillColor = [67, 97, 238];
                    data.cell.styles.textColor = [255, 255, 255];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        });
        
        // Save the PDF
        doc.save('feedback_reports.pdf');
      } catch (error) {
        console.error('PDF Export Error:', error);
        alert('Error exporting to PDF: ' + error.message);
      }
    }
  </script>
</body>
</html> 