<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Sit-ins - CCS Sit-In System</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <style>
    :root {
        --primary-color: #B4121B;        /* Primary brand red */
        --secondary-color: #8C0D15;      /* Darker red for hover states */
        --accent-color: #D6454F;         /* Brighter red for accents */
        --light-color: #f8f9fa;          /* Light background */
        --dark-color: #000000;           /* Pure black for text and headers */
        --success-color: #2bc4a9;        /* Teal for success states */
        --warning-color: #f9c74f;        /* Gold for warnings */
        --danger-color: #B4121B;         /* Same as primary for danger states */
        --border-radius: 8px;            /* Consistent border radius */
        --box-shadow: 0 4px 15px rgba(0,0,0,0.05); /* Standard shadow */
    }

    body {
        font-family: Georgia, serif;
        background-color: #f5f7fa;
        color: #495057;
        min-height: 100vh;
        line-height: 1.6;
    }

    /* Header Styles */
    .header-banner {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 20px 0;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-banner::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 0;
        right: 0;
        height: 20px;
        background: #fff;
        border-radius: 50% 50% 0 0;
    }

    /* Navigation Bar */
    .navbar {
        background-color: #fff !important;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        border-bottom: 2px solid var(--primary-color);
        padding: 0.5rem 1rem;
    }

    .navbar .nav-link {
        color: var(--dark-color) !important;
        font-weight: 500;
        padding: 10px 16px !important;
        border-radius: var(--border-radius);
        transition: all 0.3s ease;
        font-size: 0.95rem;
        margin: 0 3px;
    }

    .navbar .nav-link:hover {
        background-color: rgba(180, 18, 27, 0.1);
        color: var(--primary-color) !important;
        transform: translateY(-2px);
    }

    .navbar .nav-item.active .nav-link {
        background-color: var(--primary-color);
        color: white !important;
        box-shadow: 0 4px 12px rgba(180, 18, 27, 0.25);
    }

    /* Card Styles */
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: var(--box-shadow);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        margin-bottom: 25px;
        overflow: hidden;
        border-top: 3px solid var(--primary-color);
        background-color: white;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    .card-header {
        background: var(--dark-color);
        color: white;
        font-weight: 600;
        padding: 18px 25px;
        border-bottom: 2px solid var(--primary-color);
        border-radius: 15px 15px 0 0 !important;
    }

    .card-body {
        padding: 25px;
    }

    /* Button Styles */
    .btn {
        border-radius: var(--border-radius);
        padding: 10px 20px;
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        color: white;
    }

    .btn-primary {
        background: var(--primary-color);
        box-shadow: 0 2px 5px rgba(180, 18, 27, 0.2);
    }

    .btn-primary:hover {
        background: var(--secondary-color);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(180, 18, 27, 0.3);
    }

    .btn-success {
        background: var(--success-color);
    }

    .btn-success:hover {
        background: #24a08c;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(43, 196, 169, 0.3);
    }

    .btn-danger {
        background: var(--danger-color);
    }

    .btn-danger:hover {
        background: var(--secondary-color);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(180, 18, 27, 0.3);
    }

    .btn-warning {
        background: var(--warning-color);
        color: var(--dark-color);
    }

    .btn-warning:hover {
        background: #e0b441;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(249, 199, 79, 0.3);
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.85rem;
    }

    /* Table Styles */
    .table {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: var(--box-shadow);
        margin-bottom: 1.5rem;
    }

    .table thead th {
        background-color: var(--dark-color);
        color: white;
        border: none;
        font-weight: 600;
        padding: 15px;
        border-bottom: 2px solid var(--primary-color);
    }

    .table td {
        padding: 15px;
        vertical-align: middle;
        border-color: #f0f0f0;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: rgba(180, 18, 27, 0.05);
    }

    /* Badge Styles */
    .badge {
        padding: 6px 10px;
        font-weight: 500;
        border-radius: var(--border-radius);
        color: white;
    }

    .badge-primary {
        background-color: var(--primary-color);
    }

    .badge-success {
        background-color: var(--success-color);
    }

    .badge-warning {
        background-color: var(--warning-color);
        color: var(--dark-color);
    }

    .badge-danger {
        background-color: var(--danger-color);
    }

    /* Form Styles */
    .form-control {
        border-radius: var(--border-radius);
        border: 1px solid #e1e1e1;
        padding: 12px 15px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(180, 18, 27, 0.25);
        background-color: #fff;
    }

    /* Scrollbar Styles */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-thumb {
        background-color: var(--primary-color);
        border-radius: 4px;
    }
    ::-webkit-scrollbar-track {
        background-color: #f1f1f1;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .navbar .nav-link {
            padding: 8px 12px !important;
            margin: 2px 0;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn {
            padding: 8px 16px;
        }
    }
</style>
</head>

<body>
    <!-- Header Banner -->
    <div class="header-banner">
        <div class="container text-center">
            <h3 class="font-weight-bold mb-0">College of Computer Studies Admin</h3>
        </div>
    </div>

    <!-- Include Admin Navbar -->
    {% include 'admin_navbar.html' %}

    <!-- Add this after the navbar -->
    <div class="container mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Search Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">Search Student</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="searchInput"><i class="fas fa-id-card mr-1"></i> Student ID</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Enter student ID">
                    </div>
                    <button class="btn btn-primary" id="searchStudentBtn">
                        <i class="fas fa-search mr-1"></i> Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-5">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <div>
                            <i class="fas fa-clipboard-list mr-2"></i> Completed Sit-in Records
                        </div>
                        <button class="btn btn-success" data-toggle="modal" data-target="#sitInModal">
                            <i class="fas fa-plus-circle mr-1"></i> New Sit-In
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="filter-bar d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    <select id="entriesPerPage" class="form-control form-control-sm">
                                        <option value="10">10 entries</option>
                                        <option value="25">25 entries</option>
                                        <option value="50">50 entries</option>
                                        <option value="100">100 entries</option>
                                    </select>
                                </div>
                            </div>
                            <div class="position-relative">
                                <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search...">
                                <i class="fas fa-search position-absolute" style="right: 10px; top: 10px; color: #777;"></i>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-hashtag mr-1"></i> Sit-in ID</th>
                                        <th><i class="fas fa-id-card mr-1"></i> Student ID</th>
                                        <th><i class="fas fa-user mr-1"></i> Student Name</th>
                                        <th><i class="fas fa-tasks mr-1"></i> Purpose</th>
                                        <th><i class="fas fa-laptop-house mr-1"></i> Lab</th>
                                        <th><i class="fas fa-calendar mr-1"></i> Date</th>
                                        <th><i class="fas fa-clock mr-1"></i> Login Time</th>
                                        <th><i class="fas fa-clock mr-1"></i> Logout Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if sitins %}
                                        {% for sitin in sitins %}
                                            <tr>
                                                <td>{{ sitin.sitin_id }}</td>
                                                <td>{{ sitin.student_id }}</td>
                                                <td>{{ sitin.firstname }} {{ sitin.lastname }}</td>
                                                <td>{{ sitin.purpose }}</td>
                                                <td>{{ sitin.lab_number }}</td>
                                                <td>{{ sitin.login_date if sitin.login_date else 'N/A' }}</td>
                                                <td>{{ sitin.login_time if sitin.login_time else 'N/A' }}</td>
                                                <td>{{ sitin.logout_time if sitin.logout_time else 'N/A' }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <i class="fas fa-info-circle fa-2x mb-3 text-muted"></i>
                                                <p class="mb-0 text-muted">No completed sit-in records found</p>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if sitins and sitins|length > 10 %}
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div>
                                <p class="text-muted mb-0">Showing 1 to {{ sitins|length if sitins|length < 10 else 10 }} of {{ sitins|length }} entries</p>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sit-In Modal -->
    <div class="modal fade" id="sitInModal" tabindex="-1" role="dialog" aria-labelledby="sitInModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sitInModalLabel">New Sit-In</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Search section -->
                    <div id="searchSection">
                        <div class="form-group">
                            <label for="studentID"><i class="fas fa-id-card mr-1"></i> Student ID</label>
                            <input type="text" id="studentID" class="form-control" placeholder="Enter student ID">
                        </div>
                        <div id="sessionWarning" class="alert alert-warning" style="display: none;">
                            <strong>Warning:</strong> This student has low or no remaining sessions.
                        </div>
                        <button id="searchButton" class="btn btn-primary">
                            <i class="fas fa-search mr-1"></i> Search
                        </button>
                    </div>
                    
                    <!-- Sit-in form section (hidden initially) -->
                    <div id="sitInFormSection" style="display: none;">
                        <form id="sitInForm">
                            <div class="form-group">
                                <label for="idNumber"><i class="fas fa-id-card mr-1"></i> ID Number</label>
                                <input type="text" id="idNumber" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="studentName"><i class="fas fa-user mr-1"></i> Student Name</label>
                                <input type="text" id="studentName" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="purpose"><i class="fas fa-tasks mr-1"></i> Purpose</label>
                                <select id="purpose" class="form-control">
                                    <option value="Python Programming">Python Programming</option>
                                    <option value="C Programming">C Programming</option>
                                    <option value="C# Programming">C# Programming</option>
                                    <option value="Java Programming">Java Programming</option>
                                    <option value=".NET Programming">.NET Programming</option>
                                    <option value="PHP Programming">PHP Programming</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lab"><i class="fas fa-laptop-house mr-1"></i> Lab</label>
                                <select id="lab" class="form-control">
                                    <option value="524">524</option>
                                    <option value="526">526</option>
                                    <option value="528">528</option>
                                    <option value="530">530</option>
                                    <option value="542">542</option>
                                    <option value="544">544</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="remainingSession"><i class="fas fa-ticket-alt mr-1"></i> Remaining Sessions</label>
                                <input type="text" id="remainingSession" class="form-control font-weight-bold" readonly>
                            </div>
                            <div id="formSessionWarning" class="alert alert-info mb-3" style="display: none;">
                                <i class="fas fa-info-circle mr-1"></i> <strong>Note:</strong> This session will be deducted when the sit-in is completed.
                            </div>
                            <div class="text-right">
                                <button type="button" id="backToSearchButton" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left mr-1"></i> Back
                                </button>
                                <button type="button" id="sitInButton" class="btn btn-success">
                                    <i class="fas fa-check-circle mr-1"></i> Submit Sit-In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {
            // Table search functionality
            $("#tableSearch").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $("table tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
            
            // Search button click handler
            $("#searchButton").click(function() {
                const studentId = $("#studentID").val().trim();
                if (!studentId) {
                    alert("Please enter a student ID");
                    return;
                }

                // Check the remaining sessions
                $.ajax({
                    url: "/get_user_sessions/" + studentId,
                    type: "GET",
                    success: function(response) {
                        const user = response.user;
                        const remainingSessions = user.remaining_sessions;
                        
                        // Show warning if sessions are low
                        if (remainingSessions <= 0) {
                            $("#sessionWarning").text("Warning: This student has no remaining sessions and cannot sit in.").show();
                            return;
                        } else if (remainingSessions <= 5) {
                            $("#sessionWarning").text(`Warning: This student has only ${remainingSessions} sessions remaining.`).show();
                        } else {
                            $("#sessionWarning").hide();
                        }
                        
                        // Switch to sit-in form and populate data
                        $("#searchSection").hide();
                        $("#sitInFormSection").show();
                        
                        // Populate the form with student data
                        $("#idNumber").val(user.idno);
                        $("#studentName").val(user.name);
                        $("#remainingSession").val(remainingSessions);
                        
                        // Show the form session warning
                        $("#formSessionWarning").show();
                    },
                    error: function(xhr) {
                        if (xhr.status === 404) {
                            alert("Student not found");
                        } else {
                            alert("Error checking student information: " + (xhr.responseJSON?.error || "Unknown error"));
                        }
                    }
                });
            });

            // Back to search button handler
            $("#backToSearchButton").click(function() {
                $("#sitInFormSection").hide();
                $("#searchSection").show();
                $("#sessionWarning").hide();
                $("#formSessionWarning").hide();
                $("#studentID").val("").focus();
            });
            
            // Reset the sit-in form when modal is closed
            $("#sitInModal").on("hidden.bs.modal", function() {
                $("#sitInFormSection").hide();
                $("#searchSection").show();
                $("#sessionWarning").hide();
                $("#formSessionWarning").hide();
                $("#studentID").val("");
            });
            
            // Sit In button handler
            $("#sitInButton").click(function() {
                // Get the form values directly from the form elements
                const studentId = $("#idNumber").val().trim();
                const purpose = $("#purpose").val();
                const labNumber = $("#lab").val();
                
                // Basic validation
                if (!studentId) {
                    alert("Student ID is required");
                    $("#idNumber").focus();
                    return;
                }
                
                if (!purpose) {
                    alert("Purpose is required");
                    $("#purpose").focus();
                    return;
                }
                
                if (!labNumber) {
                    alert("Lab is required");
                    $("#lab").focus();
                    return;
                }
                
                // Prepare the data object
                const requestData = {
                    student_id: studentId,
                    lab_number: labNumber,
                    purpose: purpose
                };
                
                // Disable the button to prevent double submissions
                $("#sitInButton").prop("disabled", true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
                
                // Send the AJAX request
                $.ajax({
                    url: "/submit_sitin",
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        alert("Sit-in created successfully!");
                        $("#sitInModal").modal("hide");
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = "Unknown error occurred";
                        
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            } else if (xhr.responseText) {
                                // Try to parse the response text as JSON
                                const errorData = JSON.parse(xhr.responseText);
                                errorMessage = errorData.error || errorMessage;
                            }
                        } catch (e) {
                            console.error("Error parsing error response:", e);
                        }
                        
                        alert("Error creating sit-in: " + errorMessage);
                        
                        // Re-enable the button
                        $("#sitInButton").prop("disabled", false).text("Sit In");
                    }
                });
            });
            
            // Search student button click handler
            $('#searchStudentBtn').click(function() {
                const studentId = $('#searchInput').val().trim();
                if (studentId === '') {
                    alert('Please enter a student ID');
                    return;
                }
                
                // Search for the student 
                $.ajax({
                    url: "/search_student",
                    type: "GET",
                    data: { idno: studentId },
                    success: function(response) {
                        // Close search modal
                        $('#searchModal').modal('hide');
                        
                        // Redirect to the sit-in page to process the student
                        window.location.href = `/sitin?search_id=${response.idno}`;
                    },
                    error: function(xhr) {
                        let errorMsg = "Student not found.";
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        alert(errorMsg);
                    }
                });
            });
        });
    </script>
</body>
</html> 